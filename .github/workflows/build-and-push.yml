# ============================================================================
# ğŸ³ Ultimate PHP Docker - å¤šç‰ˆæœ¬ PHP é•œåƒè‡ªåŠ¨æ„å»ºä¸æ¨é€
# ============================================================================
#
# ğŸ“‹ åŠŸèƒ½è¯´æ˜:
#   è‡ªåŠ¨æ„å»º Nginx + PHP-FPM ä¸€ä½“åŒ– Docker é•œåƒï¼Œè¦†ç›– PHP 5.6 ~ 8.4 å…¨ç‰ˆæœ¬ï¼Œ
#   æ¨é€è‡³ GitHub Container Registry (ghcr.io)ï¼Œå¼€ç®±å³ç”¨ã€‚
#
# ğŸ¯ ä½¿ç”¨åœºæ™¯:
#   1. ThinkPHP 5/6/8 é¡¹ç›®çš„å®¹å™¨åŒ–éƒ¨ç½²
#   2. Laravel 5~12 é¡¹ç›®çš„å®¹å™¨åŒ–éƒ¨ç½²
#   3. è€æ—§ PHP é¡¹ç›®çš„ç»´æŠ¤ï¼ˆPHP 5.6/7.x å…¼å®¹é•œåƒï¼‰
#   4. CI/CD æµæ°´çº¿ä¸­ä½œä¸ºåŸºç¡€è¿è¡Œç¯å¢ƒ
#   5. æœ¬åœ°å¼€å‘ç¯å¢ƒå¿«é€Ÿæ­å»ºï¼ˆæ›¿ä»£ XAMPP/WAMP/å®å¡”ï¼‰
#
# ğŸš€ è§¦å‘æ–¹å¼:
#   - æ¨é€åˆ° main åˆ†æ”¯ â†’ è‡ªåŠ¨æ„å»ºå…¨éƒ¨ 11 ä¸ª PHP ç‰ˆæœ¬çš„é•œåƒ
#   - æ‰‹åŠ¨è§¦å‘ â†’ åœ¨ GitHub Actions é¡µé¢ç‚¹å‡» "Run workflow" æŒ‰é’®
#
# ğŸ“¦ é•œåƒæ‹‰å–ç¤ºä¾‹:
#   docker pull ghcr.io/elijah-hall-asdq1/ultimate-php-docker:php-8.3
#
# ğŸƒ å¿«é€Ÿè¿è¡Œç¤ºä¾‹:
#   docker run -d -p 8080:80 -v $(pwd)/my-project:/var/www/html \
#     ghcr.io/elijah-hall-asdq1/ultimate-php-docker:php-8.3
#
# ğŸ“ å®¹å™¨å†…ç›®å½•ç»“æ„:
#   /var/www/html/          â† æŒ‚è½½ä½ çš„é¡¹ç›®åˆ°è¿™é‡Œ
#   /var/www/html/public/   â† Nginx Web æ ¹ç›®å½•ï¼ˆThinkPHP/Laravel æ ‡å‡†å…¥å£ï¼‰
#
# âš ï¸ æ³¨æ„äº‹é¡¹:
#   - éœ€è¦åœ¨ä»“åº“ Settings â†’ Packages ä¸­ç¡®ä¿ GITHUB_TOKEN æœ‰ packages:write æƒé™
#   - é¦–æ¬¡æ¨é€åéœ€è¦åˆ° Packages é¡µé¢å°†é•œåƒå¯è§æ€§è®¾ä¸º Publicï¼ˆå¦‚éœ€å…¬å¼€è®¿é—®ï¼‰
#   - PHP 5.6/7.0~7.3 å·²ç» EOLï¼Œä»…ç”¨äºç»´æŠ¤è€æ—§é¡¹ç›®ï¼Œæ–°é¡¹ç›®è¯·ä½¿ç”¨ 8.1+
#   - æ„å»ºæ”¯æŒ linux/amd64 å’Œ linux/arm64 åŒæ¶æ„ï¼ˆå…¼å®¹ Apple Silicon Macï¼‰
#
# ============================================================================

name: Build and Push PHP Docker Images

on:
  # -------------------------------------------------------
  # è§¦å‘æ¡ä»¶ 1: æ¨é€åˆ° main åˆ†æ”¯è‡ªåŠ¨è§¦å‘
  # -------------------------------------------------------
  # é€‚ç”¨åœºæ™¯: ä¿®æ”¹äº† Dockerfileã€config/ é…ç½®ã€æˆ–å·¥ä½œæµæœ¬èº«åï¼Œ
  #          æ¨é€ä»£ç å³è‡ªåŠ¨é‡æ–°æ„å»ºæ‰€æœ‰é•œåƒï¼Œä¿æŒé•œåƒä¸æºç åŒæ­¥ã€‚
  push:
    branches: [main]

  # -------------------------------------------------------
  # è§¦å‘æ¡ä»¶ 2: æ‰‹åŠ¨è§¦å‘ï¼ˆå¯åœ¨ Actions é¡µé¢ç‚¹å‡» Run workflowï¼‰
  # -------------------------------------------------------
  # é€‚ç”¨åœºæ™¯:
  #   - éœ€è¦å•ç‹¬é‡å»ºæŸä¸ªç‰ˆæœ¬çš„é•œåƒï¼ˆå¦‚ PHP å‘å¸ƒå®‰å…¨è¡¥ä¸åï¼‰
  #   - æ’æŸ¥ç‰¹å®šç‰ˆæœ¬çš„æ„å»ºé—®é¢˜
  #   - ä¸æƒ³ä¿®æ”¹ä»£ç ä½†éœ€è¦é‡æ–°æ¨é€é•œåƒï¼ˆå¦‚ ghcr.io æ¸…ç†åæ¢å¤ï¼‰
  workflow_dispatch:
    inputs:
      php_versions:
        description: 'è¦æ„å»ºçš„ PHP ç‰ˆæœ¬ï¼ˆé€—å·åˆ†éš”ï¼Œç•™ç©ºåˆ™æ„å»ºå…¨éƒ¨ï¼‰ç¤ºä¾‹: 8.3,8.2'
        required: false
        default: ''

# ============================================================================
# å…¨å±€ç¯å¢ƒå˜é‡
# ============================================================================
env:
  # GitHub Container Registry åœ°å€
  REGISTRY: ghcr.io
  # é•œåƒåç§°ï¼Œè‡ªåŠ¨ä» github.repository è·å–ï¼ˆæ ¼å¼: owner/repoï¼‰
  # æœ€ç»ˆé•œåƒåœ°å€: ghcr.io/elijah-hall-asdq1/ultimate-php-docker:php-X.X
  IMAGE_NAME: ${{ github.repository }}

# ============================================================================
# æ„å»ºä»»åŠ¡
# ============================================================================
jobs:
  build-and-push:
    runs-on: ubuntu-latest

    # ------------------------------------------------------------------
    # æ„å»ºçŸ©é˜µ - å®šä¹‰æ‰€æœ‰è¦æ„å»ºçš„ PHP ç‰ˆæœ¬åŠå¯¹åº”çš„ Dockerfile
    # ------------------------------------------------------------------
    # ğŸ“ ä¸ºä»€ä¹ˆéœ€è¦ä¸‰ä¸ª Dockerfileï¼Ÿ
    #   - Dockerfile        â†’ PHP 7.4+: GD æ‰©å±•ä½¿ç”¨æ–°é…ç½®è¯­æ³• (--with-freetype --with-jpeg)
    #   - Dockerfile.php7   â†’ PHP 7.0~7.3: GD ä½¿ç”¨æ—§è¯­æ³• (--with-freetype-dir --with-jpeg-dir)
    #   - Dockerfile.php56  â†’ PHP 5.6: éœ€é¢å¤–å®‰è£… mysql/mcrypt æ‰©å±•ï¼Œä¸” Redis ç‰ˆæœ¬å—é™
    #
    # ğŸ’¡ å¦‚ä½•æ–°å¢ PHP ç‰ˆæœ¬ï¼Ÿ
    #   åœ¨ matrix.include ä¸­æ·»åŠ ä¸€æ¡è®°å½•å³å¯ï¼Œä¾‹å¦‚:
    #     - php-version: '8.5'
    #       dockerfile: Dockerfile
    #
    # ğŸ”§ fail-fast: false è¡¨ç¤ºæŸä¸ªç‰ˆæœ¬æ„å»ºå¤±è´¥ä¸å½±å“å…¶ä»–ç‰ˆæœ¬ç»§ç»­æ„å»º
    strategy:
      fail-fast: false
      matrix:
        include:
          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          # PHP 5.6 - ä½¿ç”¨ Dockerfile.php56
          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          # ğŸ“Œ é€‚ç”¨æ¡†æ¶: ThinkPHP 5ï¼ˆæ—©æœŸç‰ˆæœ¬ï¼‰
          # âš ï¸ å·² EOLï¼Œä»…ä¾›ç»´æŠ¤è€æ—§é¡¹ç›®ä½¿ç”¨ï¼
          # ğŸ”§ ç‰¹æ®Šç‚¹: åŒ…å«å·²åºŸå¼ƒçš„ mysql æ‰©å±• å’Œ mcrypt æ‰©å±•
          # ğŸ”§ Composer: v2.2ï¼ˆæœ€åæ”¯æŒ PHP 5.6 çš„ç‰ˆæœ¬ï¼‰
          # ğŸ”§ Redis æ‰©å±•: v4.3.0ï¼ˆæœ€åæ”¯æŒ PHP 5.6 çš„ç‰ˆæœ¬ï¼‰
          - php-version: '5.6'
            dockerfile: Dockerfile.php56

          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          # PHP 7.0 - 7.3 - ä½¿ç”¨ Dockerfile.php7
          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          # ğŸ“Œ é€‚ç”¨æ¡†æ¶: ThinkPHP 5/6, Laravel 5~7
          # âš ï¸ å·² EOLï¼Œå»ºè®®å°½å¿«å‡çº§åˆ° 8.x ç³»åˆ—
          # ğŸ”§ GD æ‰©å±•ä½¿ç”¨æ—§é…ç½®è¯­æ³• (--with-freetype-dir)
          # ğŸ”§ Composer: v2.2 | Redis æ‰©å±•: v5.3.7
          # ğŸ’¡ ä½¿ç”¨åœºæ™¯:
          #   - ThinkPHP 5 é¡¹ç›®è¿ç§»è¿‡æ¸¡æœŸ
          #   - Laravel 5.x/6.x è€é¡¹ç›®ç»´æŠ¤
          #   - ä¾èµ–äº†åªå…¼å®¹ PHP 7.x çš„ç¬¬ä¸‰æ–¹åº“
          - php-version: '7.0'
            dockerfile: Dockerfile.php7
          - php-version: '7.1'
            dockerfile: Dockerfile.php7
          - php-version: '7.2'
            dockerfile: Dockerfile.php7
          - php-version: '7.3'
            dockerfile: Dockerfile.php7

          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          # PHP 7.4+ - ä½¿ç”¨é»˜è®¤ Dockerfile
          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          # ğŸ”§ GD æ‰©å±•ä½¿ç”¨æ–°é…ç½®è¯­æ³• (--with-freetype --with-jpeg)
          # ğŸ”§ Composer: latest | Redis æ‰©å±•: latest

          # PHP 7.4
          # ğŸ“Œ é€‚ç”¨æ¡†æ¶: ThinkPHP 5/6, Laravel 6~8
          # ğŸ’¡ ä½¿ç”¨åœºæ™¯: ThinkPHP 6 é¡¹ç›®çš„ä¿å®ˆé€‰æ‹©ï¼Œå…¼å®¹æ€§æœ€å¹¿
          - php-version: '7.4'
            dockerfile: Dockerfile

          # PHP 8.0
          # ğŸ“Œ é€‚ç”¨æ¡†æ¶: ThinkPHP 6/8, Laravel 8~9
          # ğŸ’¡ ä½¿ç”¨åœºæ™¯: å¼€å§‹ä½¿ç”¨ PHP 8 æ–°ç‰¹æ€§ï¼ˆå‘½åå‚æ•°ã€match è¡¨è¾¾å¼ç­‰ï¼‰
          - php-version: '8.0'
            dockerfile: Dockerfile

          # PHP 8.1 â­ æ¨è - LTS çº§ç¨³å®šæ€§
          # ğŸ“Œ é€‚ç”¨æ¡†æ¶: ThinkPHP 6/8, Laravel 9~10
          # ğŸ’¡ ä½¿ç”¨åœºæ™¯: ç”Ÿäº§ç¯å¢ƒç¨³å®šé¦–é€‰ï¼Œæšä¸¾/Fiber/åªè¯»å±æ€§ç­‰æ–°ç‰¹æ€§
          - php-version: '8.1'
            dockerfile: Dockerfile

          # PHP 8.2
          # ğŸ“Œ é€‚ç”¨æ¡†æ¶: ThinkPHP 8, Laravel 10~11
          # ğŸ’¡ ä½¿ç”¨åœºæ™¯: æ–°é¡¹ç›®æ¨èï¼Œåªè¯»ç±»ã€DNF ç±»å‹ç­‰ç°ä»£ç‰¹æ€§
          - php-version: '8.2'
            dockerfile: Dockerfile

          # PHP 8.3 â­ æ¨è - æ–°é¡¹ç›®é¦–é€‰
          # ğŸ“Œ é€‚ç”¨æ¡†æ¶: ThinkPHP 8, Laravel 11~12
          # ğŸ’¡ ä½¿ç”¨åœºæ™¯: æ–°é¡¹ç›®é¦–é€‰ç‰ˆæœ¬ï¼Œç±»å¸¸é‡ç±»å‹ã€json_validate ç­‰
          - php-version: '8.3'
            dockerfile: Dockerfile

          # PHP 8.4 - æœ€æ–°ç‰ˆæœ¬
          # ğŸ“Œ é€‚ç”¨æ¡†æ¶: ThinkPHP 8, Laravel 12
          # ğŸ’¡ ä½¿ç”¨åœºæ™¯: å°é²œæœ€æ–°ç‰¹æ€§ï¼ˆå±æ€§é’©å­ã€ä¸å¯¹ç§°å¯è§æ€§ç­‰ï¼‰
          # âš ï¸ éƒ¨åˆ†ç¬¬ä¸‰æ–¹åº“å¯èƒ½å°šæœªå®Œå…¨å…¼å®¹
          - php-version: '8.4'
            dockerfile: Dockerfile

    # ------------------------------------------------------------------
    # æƒé™é…ç½®
    # ------------------------------------------------------------------
    # contents: read  â†’ æ‹‰å–ä»“åº“ä»£ç 
    # packages: write â†’ æ¨é€ Docker é•œåƒåˆ° ghcr.io
    permissions:
      contents: read
      packages: write

    steps:
      # ================================================================
      # Step 1: æ‹‰å–ä»“åº“ä»£ç 
      # ================================================================
      # å°†æ•´ä¸ªä»“åº“ä»£ç ï¼ˆDockerfileã€config/ã€è„šæœ¬ç­‰ï¼‰æ£€å‡ºåˆ° runner ä¸Š
      - name: Checkout repository
        uses: actions/checkout@v4

      # ================================================================
      # Step 2: è®¾ç½® QEMU æ¨¡æ‹Ÿå™¨
      # ================================================================
      # ğŸ“ ç”¨é€”: æ”¯æŒå¤šæ¶æ„æ„å»ºï¼ˆlinux/amd64 + linux/arm64ï¼‰
      # ğŸ’¡ åœºæ™¯: è®©é•œåƒåŒæ—¶æ”¯æŒ Intel/AMD æœåŠ¡å™¨å’Œ Apple Silicon Mac
      # âš ï¸ arm64 æ„å»ºä¼šæ¯” amd64 æ…¢ 2~3 å€ï¼ˆå› ä¸ºæ˜¯æ¨¡æ‹Ÿæ‰§è¡Œï¼‰
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # ================================================================
      # Step 3: è®¾ç½® Docker Buildx
      # ================================================================
      # ğŸ“ ç”¨é€”: å¯ç”¨ Docker Buildx é«˜çº§æ„å»ºåŠŸèƒ½
      # ğŸ’¡ æä¾›: å¤šå¹³å°æ„å»ºã€æ„å»ºç¼“å­˜ã€å¹¶è¡Œæ„å»ºå±‚ç­‰èƒ½åŠ›
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ================================================================
      # Step 4: ç™»å½• GitHub Container Registry
      # ================================================================
      # ğŸ“ ä½¿ç”¨ GITHUB_TOKEN è‡ªåŠ¨è®¤è¯ï¼Œæ— éœ€é¢å¤–é…ç½® Secret
      # âš ï¸ GITHUB_TOKEN çš„æƒé™é€šè¿‡ä¸Šæ–¹ permissions é…ç½®æ§åˆ¶
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ================================================================
      # Step 5: æå–é•œåƒå…ƒæ•°æ®ï¼ˆæ ‡ç­¾ & æ ‡æ³¨ï¼‰
      # ================================================================
      # ğŸ“ è‡ªåŠ¨ç”Ÿæˆé•œåƒæ ‡ç­¾ï¼Œæ ¼å¼å¦‚ä¸‹:
      #   - php-8.3          â†’ å›ºå®šæ ‡ç­¾ï¼Œå§‹ç»ˆæŒ‡å‘æœ€æ–°æ„å»º
      #   - php-8.3-20260211 â†’ æ—¥æœŸæ ‡ç­¾ï¼Œç”¨äºç‰ˆæœ¬è¿½æº¯å’Œå›æ»š
      #
      # ğŸ’¡ ä½¿ç”¨åœºæ™¯:
      #   - ç”Ÿäº§ç¯å¢ƒ: ä½¿ç”¨æ—¥æœŸæ ‡ç­¾é”å®šç‰ˆæœ¬ï¼Œé¿å…è‡ªåŠ¨æ›´æ–°å¸¦æ¥çš„é£é™©
      #     docker pull ghcr.io/elijah-hall-asdq1/ultimate-php-docker:php-8.3-20260211
      #   - å¼€å‘ç¯å¢ƒ: ä½¿ç”¨å›ºå®šæ ‡ç­¾ï¼Œå§‹ç»ˆè·å–æœ€æ–°ç‰ˆæœ¬
      #     docker pull ghcr.io/elijah-hall-asdq1/ultimate-php-docker:php-8.3
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=php-${{ matrix.php-version }}
            type=raw,value=php-${{ matrix.php-version }}-{{date 'YYYYMMDD'}}

      # ================================================================
      # Step 6: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      # ================================================================
      # ğŸ“ æ ¸å¿ƒæ­¥éª¤è¯´æ˜:
      #   - context: .                â†’ ä½¿ç”¨ä»“åº“æ ¹ç›®å½•ä½œä¸ºæ„å»ºä¸Šä¸‹æ–‡
      #   - file: matrix.dockerfile   â†’ æ ¹æ® PHP ç‰ˆæœ¬é€‰æ‹©å¯¹åº” Dockerfile
      #   - build-args: PHP_VERSION   â†’ é€šè¿‡ ARG ä¼ å…¥ PHP å…·ä½“ç‰ˆæœ¬å·
      #   - platforms: amd64 + arm64  â†’ åŒæ—¶æ„å»ºä¸¤ç§ CPU æ¶æ„çš„é•œåƒ
      #
      # ğŸš€ ç¼“å­˜ç­–ç•¥:
      #   - cache-from/cache-to: ä½¿ç”¨ GitHub Actions Cache (GHA) ä½œä¸ºæ„å»ºç¼“å­˜
      #   - mode=max: ç¼“å­˜æ‰€æœ‰æ„å»ºå±‚ï¼ˆè€Œä¸ä»…ä»…æ˜¯æœ€ç»ˆç»“æœï¼‰ï¼Œæœ€å¤§åŒ–ç¼“å­˜å‘½ä¸­ç‡
      #   - é¦–æ¬¡æ„å»ºçº¦ 5~8 åˆ†é’Ÿ/ç‰ˆæœ¬ï¼Œåç»­å¢é‡æ„å»ºçº¦ 1~2 åˆ†é’Ÿ/ç‰ˆæœ¬
      #
      # ğŸ’¡ è°ƒè¯•æŠ€å·§:
      #   - å¦‚æœæ„å»ºå¤±è´¥ï¼Œæ£€æŸ¥å¯¹åº” Dockerfile ä¸­çš„ apk åŒ…æ˜¯å¦åœ¨ alpine ä»“åº“ä¸­å¯ç”¨
      #   - PHP è€ç‰ˆæœ¬çš„ alpine åŸºç¡€é•œåƒå¯èƒ½ä¸å†æ›´æ–°ï¼Œè‹¥å‡ºé—®é¢˜å¯è€ƒè™‘åˆ‡æ¢ä¸º debian åŸºç¡€é•œåƒ
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            PHP_VERSION=${{ matrix.php-version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64
